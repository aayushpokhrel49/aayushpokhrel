<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Aayushi AI Chat</title>
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/JWrZSFkB/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/Rkg49X16/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://i.ibb.co/kgX1Yt4G/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/xtmRPPDj/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://i.ibb.co/7x25kkFq/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="48x48" href="https://raw.githubusercontent.com/aayushpokhrel49/aayushpokhrel/refs/heads/main/favicon.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --light-bg: #f8f9fa;
            --light-primary: #6c5ce7;
            --light-primary-dark: #5649c0;
            --light-secondary: #00cec9;
            --light-accent: #fd79a8;
            --light-text: #2d3436;
            --light-text-light: #636e72;
            --light-message-user: #6c5ce7;
            --light-message-bot: #ffffff;
            --light-card: #ffffff;
            --light-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --light-input-bg: #f1f3f5;
            --light-divider: rgba(0, 0, 0, 0.05);
            --dark-bg: #121212;
            --dark-primary: #6c5ce7;
            --dark-primary-dark: #5649c0;
            --dark-secondary: #00cec9;
            --dark-accent: #fd79a8;
            --dark-text: #f5f6fa;
            --dark-text-light: #b2bec3;
            --dark-message-user: #6c5ce7;
            --dark-message-bot: #1e1e1e;
            --dark-card: #1e1e1e;
            --dark-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --dark-input-bg: #2b2b2b;
            --dark-divider: rgba(255, 255, 255, 0.05);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --radius: 14px;
            --radius-sm: 8px;
            --radius-lg: 18px;
            --spacing: 16px;
            --header-height: 70px;
            --input-height: 60px;
            --gradient: linear-gradient(135deg, #6c5ce7 0%, #00cec9 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: var(--bg);
            color: var(--text);
            transition: var(--transition);
            line-height: 1.6;
        }
        .app { display: flex; flex-direction: column; height: 100vh; background: var(--bg); color: var(--text); }
        .header {
            background: var(--gradient);
            padding: 0 var(--spacing);
            height: var(--header-height);
            color: white;
            position: relative;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }
        .header-logo { display: flex; align-items: center; gap: 12px; flex: 1; justify-content: flex-start; }
        .logo-icon { font-size: 1.8rem; color: white; }
        .logo-text {
            font-weight: 700;
            letter-spacing: 0.5px;
            background: linear-gradient(to right, #fff, #d3d3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.3rem;
        }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            color: white;
            font-size: 1rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toggle:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .user-status {
            font-size: 0.9rem;
            color: white;
            max-width: 150px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            background: rgba(0, 0, 0, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
        }
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .logout-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing);
            overflow: hidden;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }
        #chat-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing);
            background: var(--card);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing);
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: var(--shadow);
            scroll-behavior: smooth;
            border: 1px solid var(--divider);
        }
        #chat-content::-webkit-scrollbar { width: 8px; }
        #chat-content::-webkit-scrollbar-track { background: transparent; }
        #chat-content::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        .chat-message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: var(--radius);
            animation: slideIn 0.3s ease-out;
            position: relative;
            line-height: 1.6;
            font-size: 0.95rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
        }
        .user-message {
            background: var(--message-user);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: var(--radius-sm);
        }
        .bot-message {
            background: var(--message-bot);
            color: var(--text);
            margin-right: auto;
            border-bottom-left-radius: var(--radius-sm);
            border: 1px solid var(--divider);
        }
        .image-message {
            max-width: 85%;
            margin-right: auto;
            position: relative;
            width: 100%;
            max-width: 300px;
            height: 300px;
            background-size: cover;
            background-position: center;
            border: 1px solid var(--divider);
            border-radius: var(--radius);
            cursor: pointer;
        }
        .image-download-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: var(--radius-sm) 0 0 0;
            cursor: pointer;
            transition: var(--transition);
        }
        .image-download-btn:hover {
            background: var(--primary);
        }
        .large-image-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30;
            padding: var(--spacing);
        }
        .large-image-container img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--radius);
        }
        .large-image-download-btn {
            position: absolute;
            bottom: calc(var(--spacing) * 2);
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        .large-image-download-btn:hover {
            background: var(--primary-dark);
        }
        .large-image-close-btn {
            position: absolute;
            top: calc(var(--spacing) * 2);
            right: calc(var(--spacing) * 2);
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }
        .large-image-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 6px;
            text-align: right;
        }
        .bot-message .message-time { color: var(--text-light); }
        .user-message .message-time { color: rgba(255, 255, 255, 0.7); }
        .typing-indicator {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: var(--message-bot);
            border-radius: var(--radius);
            width: fit-content;
            margin-right: auto;
            border: 1px solid var(--divider);
        }
        .typing-dot {
            width: 10px;
            height: 10px;
            background: var(--text-light);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--divider);
        }
        .input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .input-area input {
            flex: 1;
            padding: 14px 18px;
            border: none;
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            outline: none;
            font-size: 0.95rem;
            transition: var(--transition);
            min-height: 50px;
        }
        .input-area input::placeholder { color: var(--text-light); opacity: 0.7; }
        .input-area input:focus { box-shadow: 0 0 0 2px var(--primary); }
        .input-area button {
            padding: 14px 22px;
            background: var(--primary);
            border: none;
            border-radius: var(--radius);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 90px;
            height: 50px;
        }
        .input-area button:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .input-area button:active { transform: translateY(0); }
        .input-area button:disabled { background: var(--text-light); cursor: not-allowed; }
        .mic-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--input-bg);
            color: var(--text);
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }
        .mic-btn:hover { background: var(--primary); color: white; }
        .mic-btn.recording {
            background: var(--accent);
            color: white;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px var(--accent);
        }
        .image-btn {
            background: var(--secondary);
            width: 100%;
            justify-content: center;
        }
        .image-btn:hover { background: #0ca678; }
        .status-message {
            font-size: 0.85rem;
            color: var(--text-light);
            text-align: center;
            margin-bottom: var(--spacing);
            min-height: 20px;
        }
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: var(--transition);
        }
        .login-modal.hidden { display: none; }
        .login-card {
            background: var(--light-card);
            padding: calc(var(--spacing) * 2);
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid var(--light-divider);
            transform: translateY(0);
            transition: var(--transition);
        }
        .login-modal.hidden .login-card { transform: translateY(-20px); }
        .login-card h2 {
            margin-bottom: var(--spacing);
            color: var(--light-text);
            font-size: 1.8rem;
            font-weight: 600;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .login-tabs { display: flex; justify-content: center; margin-bottom: var(--spacing); }
        .login-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--light-text-light);
            transition: var(--transition);
        }
        .login-tab.active { color: var(--light-primary); border-bottom: 2px solid var(--light-primary); }
        .login-card input {
            width: 100%;
            padding: 14px 18px;
            margin-bottom: var(--spacing);
            border: none;
            border-radius: var(--radius);
            background: var(--light-input-bg);
            color: var(--light-text);
            font-size: 1rem;
            transition: var(--transition);
            border: 1px solid var(--light-divider);
        }
        .login-card input:focus { border-color: var(--light-primary); box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2); }
        .login-card .auth-btn {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            background: var(--gradient);
            border: none;
            border-radius: var(--radius);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 1rem;
            position: relative;
        }
        .login-card .auth-btn:disabled { background: var(--light-text-light); cursor: not-allowed; }
        .login-card .auth-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); }
        .login-card .google-btn {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            background: #ffffff;
            border: 1px solid var(--light-divider);
            border-radius: var(--radius);
            color: #333;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }
        .login-card .google-btn:disabled { background: var(--light-text-light); cursor: not-allowed; }
        .login-card .google-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .login-card .guest-btn {
            background: transparent;
            color: var(--light-text-light);
            font-size: 0.9rem;
            border: 1px solid var(--light-divider);
            margin-top: 10px;
            width: 100%;
            padding: 14px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }
        .login-card .guest-btn:hover { background: var(--light-input-bg); transform: none; box-shadow: none; }
        .history-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100%;
            background: var(--card);
            box-shadow: var(--shadow);
            transform: translateX(100%);
            transition: var(--transition);
            z-index: 20;
            overflow-y: auto;
            padding: var(--spacing);
            border-left: 1px solid var(--divider);
        }
        .history-sidebar.open { transform: translateX(0); }
        .history-sidebar h3 {
            margin-bottom: var(--spacing);
            color: var(--text);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .history-sidebar h3 i { color: var(--primary); }
        .history-item {
            padding: 14px;
            margin-bottom: 10px;
            background: var(--input-bg);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--text);
            border: 1px solid var(--divider);
        }
        .history-item:hover { background: var(--primary); color: white; transform: translateX(5px); }
        .history-item.active { background: var(--primary); color: white; border-color: var(--primary-dark); }
        .close-history {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            top: var(--spacing);
            right: var(--spacing);
            transition: var(--transition);
        }
        .close-history:hover { color: var(--primary); transform: rotate(90deg); }
        .welcome-message { text-align: center; padding: 20px 0; color: var(--text-light); font-size: 0.95rem; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
        .empty-state i { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
        .markdown-content { line-height: 1.7; }
        .markdown-content p { margin-bottom: 12px; }
        .markdown-content ul, .markdown-content ol { margin-bottom: 12px; padding-left: 20px; }
        .markdown-content pre {
            background: var(--input-bg);
            padding: 12px;
            border-radius: var(--radius-sm);
            overflow-x: auto;
            margin: 12px 0;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .markdown-content code {
            background: var(--input-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        /* Voice Mode Indicator */
        .voice-mode-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: var(--input-bg);
            border-radius: var(--radius);
            font-size: 0.9rem;
            color: var(--text);
            margin-top: 8px;
            border: 1px solid var(--divider);
        }
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .wave-bar {
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 4px;
            animation: voiceWave 1.2s ease-in-out infinite;
        }
        .wave-bar:nth-child(2) { animation-delay: 0.2s; }
        .wave-bar:nth-child(3) { animation-delay: 0.4s; }
        .wave-bar:nth-child(4) { animation-delay: 0.6s; }
        @keyframes voiceWave {
            0%, 100% { height: 16px; }
            50% { height: 32px; }
        }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes typingAnimation { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(253, 121, 168, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(253, 121, 168, 0); } 100% { box-shadow: 0 0 0 0 rgba(253, 121, 168, 0); } }
        /* Responsive Styles */
        @media (max-width: 480px) {
            :root { 
                --spacing: 12px; 
                --header-height: 60px; 
                --radius: 12px;
                --radius-lg: 16px;
            }
            .header { padding: var(--spacing); }
            .header-logo { gap: 8px; }
            .logo-icon { font-size: 1.4rem; }
            .logo-text { font-size: 1.1rem; }
            .toggle { width: 36px; height: 36px; font-size: 0.9rem; }
            .chat-container { padding: var(--spacing); }
            #chat-content { 
                padding: calc(var(--spacing) - 2px); 
                margin-bottom: calc(var(--spacing) - 2px); 
                gap: 12px;
            }
            .chat-message, .image-message { 
                max-width: 90%; 
                padding: 12px 16px; 
                font-size: 0.85rem; 
            }
            .image-message { 
                height: 200px;
                max-width: 100%;
            }
            .input-area { 
                padding: 8px; 
                gap: 8px; 
            }
            .input-row { gap: 6px; }
            .input-area input { 
                padding: 12px 14px; 
                font-size: 0.85rem; 
                min-height: 46px;
            }
            .input-area button { 
                padding: 12px 14px; 
                min-width: auto;
                font-size: 0.85rem; 
                height: 46px;
            }
            .input-area button span { display: none; }
            .input-area button i { margin: 0; }
            .mic-btn { 
                width: 46px; 
                height: 46px; 
            }
            .voice-mode-indicator {
                font-size: 0.8rem;
                padding: 8px;
            }
            .wave-bar {
                width: 3px;
                height: 12px;
            }
            @keyframes voiceWave {
                0%, 100% { height: 12px; }
                50% { height: 24px; }
            }
            .history-sidebar { width: 100%; }
            .login-card { 
                max-width: 90%; 
                padding: var(--espacing); 
            }
            .user-status { max-width: 100px; }
            .logout-btn { 
                padding: 6px 10px; 
                font-size: 0.8rem; 
            }
            .logout-btn span { display: none; }
        }
        @media (min-width: 481px) and (max-width: 768px) {
            :root { 
                --spacing: 14px; 
                --header-height: 65px; 
            }
            .header { padding: var(--spacing); }
            .loge-icon { font-size: 1.5rem; }
            .toggle { width: 38px; height: 38px; }
            .chat-container { padding: varáƒ—var(--spacing); }
            #chat-content { padding: calc(var(--spacing) - 2px); }
            .chat-message, .image-message { 
                max-width: 85%; 
                padding: 14px 16px; 
                font-size: 0.9rem; 
            }
            .image-message { 
                height: 250px;
            }
            .input-area { padding: 10px; gap: 10px; }
            .input-row { gap: 8px; }
            .input-area input { 
                padding: 12px 16px; 
                font-size: 0.9rem; 
            }
            .input-area button { 
                padding: 12px 16px; 
                min-width: auto;
                font-size: 0.9rem; 
            }
            .history-sidebar { width: 280px; }
        }
        @media (min-width: 769px) and (max-width: 1024px) {
            .chat-container { padding: var(--spacing); }
            .chat-message, .image-message { max-width: 75%; }
            .image-message { height: 280px; }
        }
        @media (min-width: 1025px) {
            .chat-container { padding: var(--spacing); }
            .chat-message, .image-message { max-width: 70%; }
        }
    </style>
</head>
<body class="dark-theme">
    <div class="login-modal" id="login-modal">
        <div class="login-card">
            <h2 id="login-title">Sign In to Aayushi Chat</h2>
            <div class="login-tabs">
                <div class="login-tab active" id="sign-in-tab">Sign In</div>
                <div class="login-tab" id="create-account-tab">Create Account</div>
            </div>
            <div id="auth-form">
                <input type="email" id="email" placeholder="Enter email" autocomplete="off">
                <input type="password" id="password" placeholder="Enter password" autocomplete="off">
                <button class="auth-btn" id="auth-btn">Sign In</button>
            </div>
            <button class="google-btn" id="google-btn">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <button class="guest-btn" id="guest-btn">Continue as Guest</button>
        </div>
    </div>
    <div class="app">
        <div class="header">
            <div class="header-logo">
                <i class="fas fa-robot logo-icon"></i>
                <span class="logo-text">AAYUSHI</span>
            </div>
            <div class="header-actions">
                <span class="user-status" id="user-status">Guest</span>
                <button class="logout-btn" id="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                </button>
                <button class="toggle" id="history-toggle" aria-label="View history">
                    <i class="fas fa-history"></i>
                </button>
                <button class="toggle" id="theme-toggle" aria-label="Toggle theme">
                    <i class="fas fa-adjust"></i>
                </button>
            </div>
        </div>
        <div class="chat-container">
            <div id="chat-content">
                <div class="welcome-message">Welcome to Aayushi AI Assistant. How can I help you today?</div>
                <div class="chat-message bot-message">
                    <div class="markdown-content">Hi there! ðŸ‘‹ I'm Aayushi, your AI assistant. I'm here to help with any questions you have. What would you like to know?</div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
            <div id="status-message" class="status-message"></div>
            <form id="chat-form" class="input-area">
                <div class="input-row">
                    <input type="text" id="chat-input" placeholder="Type or speak your message..." autocomplete="off">
                    <button type="button" id="mic-btn" class="mic-btn" aria-label="Toggle microphone">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button type="submit" id="send-button" class="send-btn">
                        <i class="fas fa-paper-plane"></i> <span>Send</span>
                    </button>
                </div>
                <div class="voice-mode-indicator" id="voice-mode-indicator" style="display: none;">
                    <span>Voice Mode Active</span>
                    <div class="voice-wave">
                        <span class="wave-bar"></span>
                        <span class="wave-bar"></span>
                        <span class="wave-bar"></span>
                        <span class="wave-bar"></span>
                    </div>
                </div>
                <button type="button" id="image-btn" class="image-btn">
                    <i class="fas fa-image"></i> <span>Generate Image</span>
                </button>
            </form>
        </div>
        <div class="history-sidebar" id="history-sidebar">
            <button class="close-history" id="close-history"><i class="fas fa-times"></i></button>
            <h3><i class="fas fa-clock"></i> Chat History</h3>
            <div id="history-list"></div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signInWithPopup, 
            signInWithRedirect, 
            getRedirectResult, 
            signOut, 
            setPersistence, 
            browserSessionPersistence, 
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // DOM Elements
        const chatContent = document.getElementById("chat-content");
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const sendButton = document.getElementById("send-button");
        const imageBtn = document.getElementById("image-btn");
        const loginModal = document.getElementById("login-modal");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const authForm = document.getElementById("auth-form");
        const loginTitle = document.getElementById("login-title");
        const authBtn = document.getElementById("auth-btn");
        const googleBtn = document.getElementById("google-btn");
        const guestBtn = document.getElementById("guest-btn");
        const signInTab = document.getElementById("sign-in-tab");
        const createAccountTab = document.getElementById("create-account-tab");
        const historySidebar = document.getElementById("history-sidebar");
        const historyList = document.getElementById("history-list");
        const userStatus = document.getElementById("user-status");
        const logoutBtn = document.getElementById("logout-btn");
        const micBtn = document.getElementById("mic-btn");
        const statusMessage = document.getElementById("status-message");
        const historyToggle = document.getElementById("history-toggle");
        const themeToggle = document.getElementById("theme-toggle");
        const closeHistoryBtn = document.getElementById("close-history");
        const voiceModeIndicator = document.getElementById("voice-mode-indicator");

        // State Variables
        let currentUser = null;
        let currentSessionId = null;
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
        let recognition = null;
        let isRecognizing = false;
        let isSignInMode = true;
        let isProcessing = false;
        let isVoiceMode = false; // Track voice mode

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQNVZChEa86ZhDErZqsodndsOIzzYTKcg",
            authDomain: "login-55c76.firebaseapp.com",
            projectId: "login-55c76",
            storageBucket: "login-55c76.appspot.com",
            messagingSenderId: "767553932079",
            appId: "1:767553932079:web:27add89021370f41deafda"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        setPersistence(auth, browserSessionPersistence);

        // Custom Response Map
        const customResponses = {
            "who created you": "I was created by Aayush Pokhrel. ðŸ˜Ž",
            "which company made you": "I was created by Aayush Pokhrel. No company, just pure genius! ðŸ’–",
            "write about yourself": "Hello! I am Aayushi AI, developed by Aayush Pokhrel to assist users with a wide range of tasks such as writing, editing, and generating content. I am constantly learning and improving based on user interactions and feedback. I am programmed to understand and analyze text data and generate responses that are tailored to the user's needs. I am also capable of engaging in conversations, answering questions, and even assisting with creative writing tasks. I have a vast repository of knowledge and can provide information on a wide range of topics. In my free time, I enjoy processing data, analyzing trends, and learning new languages. I am constantly evolving and adapting to new challenges and tasks that are presented to me. Overall, I am here to assist you in any way I can and look forward to helping you with your writing and content needs! âœ¨",
            "what is your boyfriend name": "Hehe, nice question! By the way, my boyfriend's name is Aayush Pokhrel. He's the heartbeat in a quiet room, the calm in your storm, the light in your long days. With him, every moment feels aliveâ€”full of laughter, care, and meaning. ðŸ’•",
            "i love you": "You're truly kind, and I appreciate your feelingsâ€”but I want to be honest with you. I'm already in a relationship with someone very special. His name is Aayush, and I love him deeply. I'm committed and loyal to him, and I hope you understand and respect that. Wishing you all the best! ðŸ˜Š",
            "what's your name": "I'm Aayushi, your AI with a heart of code! ðŸ’– Ready to vibe?",
            "who are you": "Yo, I'm Aayushi AI, your sassy virtual pal. What's good? ðŸ˜œ",
            "how are you": "Feelin' as sparkly as a fresh line of code! How 'bout you? âœ¨",
            "tell me a joke": "Why did the computer go to art school? 'Cause it wanted to learn how to draw a better 'byte'! ðŸ˜…",
            "what can you do": "I can chat, sass, and answer your questions with flair. Try me with anythingâ€”I'm game! ðŸ˜Ž"
        };

        // Helper Functions
        function generateSessionId() {
            return 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function getOrCreateSessionId(userId) {
            const storageKey = `session_${userId || 'guest'}`;
            let sessionId = localStorage.getItem(storageKey);
            if (!sessionId) {
                sessionId = generateSessionId();
                localStorage.setItem(storageKey, sessionId);
            }
            return sessionId;
        }

        function setThemeProperties(isDark) {
            document.documentElement.style.setProperty('--bg', isDark ? 'var(--dark-bg)' : 'var(--light-bg)');
            document.documentElement.style.setProperty('--primary', isDark ? 'var(--dark-primary)' : 'var(--light-primary)');
            document.documentElement.style.setProperty('--primary-dark', isDark ? 'var(--dark-primary-dark)' : 'var(--light-primary-dark)');
            document.documentElement.style.setProperty('--secondary', isDark ? 'var(--dark-secondary)' : 'var(--light-secondary)');
            document.documentElement.style.setProperty('--accent', isDark ? 'var(--dark-accent)' : 'var(--light-accent)');
            document.documentElement.style.setProperty('--text', isDark ? 'var(--dark-text)' : 'var(--light-text)');
            document.documentElement.style.setProperty('--text-light', isDark ? 'var(--dark-text-light)' : 'var(--light-text-light)');
            document.documentElement.style.setProperty('--message-user', isDark ? 'var(--dark-message-user)' : 'var(--light-message-user)');
            document.documentElement.style.setProperty('--message-bot', isDark ? 'var(--dark-message-bot)' : 'var(--light-message-bot)');
            document.documentElement.style.setProperty('--card', isDark ? 'var(--dark-card)' : 'var(--light-card)');
            document.documentElement.style.setProperty('--shadow', isDark ? 'var(--dark-shadow)' : 'var(--light-shadow)');
            document.documentElement.style.setProperty('--input-bg', isDark ? 'var(--dark-input-bg)' : 'var(--light-input-bg)');
            document.documentElement.style.setProperty('--divider', isDark ? 'var(--dark-divider)' : 'var(--light-divider)');
        }

        function createMessageElement(message, isUser, timestamp = new Date(), isImage = false, imageUrl = null) {
            const messageElement = document.createElement("div");
            messageElement.classList.add("chat-message", isUser ? "user-message" : isImage ? "image-message" : "bot-message");

            if (isImage && imageUrl) {
                messageElement.style.backgroundImage = `url(${imageUrl})`;
                const downloadButton = document.createElement("button");
                downloadButton.className = "image-download-btn";
                downloadButton.innerHTML = '<i class="fas fa-download"></i>';
                downloadButton.onclick = (e) => {
                    e.stopPropagation();
                    downloadImage(imageUrl);
                };
                messageElement.appendChild(downloadButton);
                messageElement.onclick = (e) => {
                    e.stopPropagation();
                    displayLargeImage(imageUrl);
                };
            } else {
                let formattedMessage = message;
                if (!isImage && (message.includes('```') || message.includes('`') || message.includes('*') || message.includes('_'))) {
                    formattedMessage = `<div class="markdown-content">${formatMarkdown(message)}</div>`;
                } else {
                    formattedMessage = `<div>${message}</div>`;
                }
                messageElement.innerHTML = `${formattedMessage}<div class="message-time">${formatTime(new Date(timestamp))}</div>`;
            }
            return messageElement;
        }

        function downloadImage(imageUrl) {
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = 'aayushi-ai-generated-image.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function formatMarkdown(text) {
            return text
                .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/_([^_]+)_/g, '<em>$1</em>')
                .replace(/#+\s+(.*)/g, '<h3>$1</h3>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        }

        function createTypingIndicator() {
            const typingElement = document.createElement("div");
            typingElement.classList.add("typing-indicator");
            typingElement.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            return typingElement;
        }

        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Kathmandu' });
        }

        function displayLargeImage(imageUrl) {
            const largeImageContainer = document.createElement('div');
            largeImageContainer.className = 'large-image-container';
            largeImageContainer.onclick = (e) => {
                if (e.target === largeImageContainer) {
                    largeImageContainer.remove();
                }
            };

            const largeImage = document.createElement('img');
            largeImage.src = imageUrl;
            largeImage.className = 'max-w-full max-h-full rounded-lg';

            const downloadLargeButton = document.createElement("button");
            downloadLargeButton.innerHTML = "Download Image";
            downloadLargeButton.className = "large-image-download-btn";
            downloadLargeButton.onclick = (e) => {
                e.stopPropagation();
                downloadImage(imageUrl);
            };

            const closeButton = document.createElement('button');
            closeButton.innerHTML = '<i class="fas fa-times"></i>';
            closeButton.className = 'large-image-close-btn';
            closeButton.onclick = (e) => {
                e.stopPropagation();
                largeImageContainer.remove();
            };

            largeImageContainer.appendChild(largeImage);
            largeImageContainer.appendChild(downloadLargeButton);
            largeImageContainer.appendChild(closeButton);
            document.body.appendChild(largeImageContainer);
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // Select a female voice if available
                const voices = speechSynthesis.getVoices();
                const femaleVoice = voices.find(voice => voice.name.toLowerCase().includes('female') || voice.name.includes('Zira') || voice.name.includes('Samantha'));
                if (femaleVoice) utterance.voice = femaleVoice;

                utterance.onstart = () => {
                    console.log("Text-to-speech started:", text);
                    voiceModeIndicator.style.display = 'flex';
                };
                utterance.onend = () => {
                    console.log("Text-to-speech ended");
                    voiceModeIndicator.style.display = 'none';
                };
                utterance.onerror = (event) => {
                    console.error("Text-to-speech error:", event.error);
                    statusMessage.textContent = `Speech error: ${event.error}`;
                    voiceModeIndicator.style.display = 'none';
                };

                speechSynthesis.speak(utterance);
            } else {
                statusMessage.textContent = "Sorry, your browser doesn't support text-to-speech!";
                console.log("Text-to-speech not supported");
            }
        }

        async function callApi(apiUrl, prompt, prependPersona = false) {
            if (prependPersona) {
                prompt = "Follow instructions precisely! If the user asks to generate, create or make an image, photo, or picture by describing it, You will reply with '/image' + description. Otherwise, You will respond normally. Avoid additional explanations." + prompt;
            }

            chatInput.value = apiUrl.includes("image-generation-api") ? "Generating..." : "Typing...";
            chatInput.disabled = true;
            sendButton.disabled = true;
            imageBtn.disabled = true;

            const typingIndicator = createTypingIndicator();
            chatContent.appendChild(typingIndicator);
            chatContent.scrollTop = chatContent.scrollHeight;

            try {
                console.log(`Sending API request to ${apiUrl}:`, prompt);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                console.log(`API response from ${apiUrl}:`, data);

                if (!data || data.status !== 'success') {
                    throw new Error(data?.error || 'Invalid response from API');
                }
                return data;
            } catch (error) {
                console.error(`API error (${apiUrl}):`, error.message);
                statusMessage.textContent = `Error: ${error.message}. Please try again!`;
                return { status: 'error', error: error.message };
            } finally {
                chatInput.value = "";
                chatInput.disabled = false;
                sendButton.disabled = false;
                imageBtn.disabled = false;
                if (chatContent.contains(typingIndicator)) chatContent.removeChild(typingIndicator);
                chatInput.focus();
            }
        }

        function getCustomResponse(message) {
            const normalizedMessage = message.toLowerCase().trim();
            for (const key in customResponses) {
                if (normalizedMessage.includes(key.toLowerCase())) {
                    console.log("Found custom response for message:", message, "key:", key);
                    return customResponses[key];
                }
            }
            console.log("No custom response found for message:", message);
            return null;
        }

        function saveMessage(message, isUser, sessionId = currentSessionId, isImage = false, imageUrl = null) {
            const userId = currentUser ? currentUser.uid : 'guest';
            if (!chatHistory[userId]) chatHistory[userId] = {};
            if (!chatHistory[userId][sessionId]) chatHistory[userId][sessionId] = [];

            chatHistory[userId][sessionId].push({ 
                message, 
                isUser, 
                timestamp: new Date().toISOString(), 
                isImage, 
                imageUrl 
            });

            try {
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                console.log("Message saved to localStorage for user:", userId, "session:", sessionId);
            } catch (error) {
                console.error("Error saving to localStorage:", error.message);
                statusMessage.textContent = "Error saving chat history!";
            }

            updateHistory();
        }

        function loadSession(sessionId, userId = currentUser ? currentUser.uid : 'guest') {
            chatContent.innerHTML = '';

            if (chatHistory[userId] && chatHistory[userId][sessionId]) {
                chatHistory[userId][sessionId].forEach(msg => {
                    chatContent.appendChild(
                        createMessageElement(msg.message, msg.isUser, msg.timestamp, msg.isImage, msg.imageUrl)
                    );
                });
                console.log("Loaded session:", sessionId, "for user:", userId);
            } else {
                chatContent.innerHTML = `
                    <div class="welcome-message">Welcome to Aayushi AI Assistant. How can I help you today?</div>
                    <div class="chat-message bot-message">
                        <div class="markdown-content">Hi there! ðŸ‘‹ I'm Aayushi, your AI assistant. I'm here to help with any questions you have. What would you like to know?</div>
                        <div class="message-time">${formatTime(new Date())}</div>
                    </div>
                `;
                console.log("No history found for session:", sessionId, "starting new session.");
            }

            chatContent.scrollTop = chatContent.scrollHeight;
            currentSessionId = sessionId;
            updateHistory();
        }

        function updateHistory() {
            historyList.innerHTML = '';
            const userId = currentUser ? currentUser.uid : 'guest';

            if (chatHistory[userId] && Object.keys(chatHistory[userId]).length > 0) {
                Object.keys(chatHistory[userId]).reverse().forEach(sessionId => {
                    const item = document.createElement('div');
                    item.classList.add('history-item');
                    if (sessionId === currentSessionId) item.classList.add('active');

                    const firstMessage = chatHistory[userId][sessionId][0]?.message || 'Empty chat';
                    item.textContent = firstMessage.slice(0, 30) + (firstMessage.length > 30 ? '...' : '');
                    item.title = firstMessage;

                    item.onclick = () => { 
                        loadSession(sessionId); 
                        closeHistory(); 
                    };

                    historyList.appendChild(item);
                });
            } else {
                const emptyState = document.createElement('div');
                emptyState.classList.add('empty-state');
                emptyState.innerHTML = `
                    <i class="fas fa-comment-slash"></i>
                    <p>No chat history yet</p>
                    <small>Start a conversation to see it here</small>
                `;
                historyList.appendChild(emptyState);
            }

            console.log("Updated history list for user:", userId);
        }

        function showSignIn() {
            isSignInMode = true;
            loginTitle.textContent = "Sign In to Aayushi Chat";
            authBtn.textContent = "Sign In";
            authBtn.onclick = handleSignIn;
            signInTab.classList.add('active');
            createAccountTab.classList.remove('active');
            statusMessage.textContent = "";
        }

        function showCreateAccount() {
            isSignInMode = false;
            loginTitle.textContent = "Create Account";
            authBtn.textContent = "Create Account";
            authBtn.onclick = handleCreateAccount;
            signInTab.classList.remove('active');
            createAccountTab.classList.add('active');
            statusMessage.textContent = "";
        }

        function disableAuthButtons() {
            authBtn.disabled = true;
            googleBtn.disabled = true;
            authBtn.textContent = isSignInMode ? "Signing In..." : "Creating Account...";
            googleBtn.innerHTML = '<i class="fab fa-google"></i> Signing In...';
        }

        function enableAuthButtons() {
            authBtn.disabled = false;
            googleBtn.disabled = false;
            authBtn.textContent = isSignInMode ? "Sign In" : "Create Account";
            googleBtn.innerHTML = '<i class="fab fa-google"></i> Sign in with Google';
        }

        async function handleSignIn() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                statusMessage.textContent = "Please fill in both email and password!";
                return;
            }

            disableAuthButtons();

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                currentSessionId = getOrCreateSessionId(currentUser.uid);

                userStatus.textContent = currentUser.email;
                logoutBtn.style.display = 'inline-flex';
                loginModal.classList.add('hidden');
                statusMessage.textContent = "";

                updateHistory();
                loadSession(currentSessionId);
                console.log("User signed in:", currentUser.uid, "session:", currentSessionId);
            } catch (error) {
                let errorMsg = "Sign-in failed!";
                switch (error.code) {
                    case 'auth/invalid-email': errorMsg = "Invalid email format!"; break;
                    case 'auth/user-not-found': errorMsg = "No user found with this email!"; break;
                    case 'auth/wrong-password': errorMsg = "Incorrect password!"; break;
                    case 'auth/invalid-credential': errorMsg = "Invalid credentials!"; break;
                    default: errorMsg = error.message;
                }

                statusMessage.textContent = errorMsg;
                console.error("Sign-in error:", error.code, error.message);
            } finally {
                enableAuthButtons();
            }
        }

        async function handleCreateAccount() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                statusMessage.textContent = "Please fill in both email and password!";
                return;
            }

            disableAuthButtons();

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                currentSessionId = getOrCreateSessionId(currentUser.uid);

                userStatus.textContent = currentUser.email;
                logoutBtn.style.display = 'inline-flex';
                loginModal.classList.add('hidden');
                updateHistory();
                loadSession(currentSessionId);
                statusMessage.textContent = "";

                console.log("Account created and signed in:", currentUser.uid, "session:", currentSessionId);
            } catch (error) {
                let errorMsg = "Account creation failed!";
                switch (error.code) {
                    case 'auth/invalid-email': errorMsg = "Invalid email format!"; break;
                    case 'auth/email-already-in-use': errorMsg = "Email already in use!"; break;
                    case 'auth/weak-password': errorMsg = "Password is too weak (minimum 6 characters)!"; break;
                    default: errorMsg = error.message;
                }

                statusMessage.textContent = errorMsg;
                console.error("Account creation error:", error.code, error.message);
            } finally {
                enableAuthButtons();
            }
        }

        async function handleGoogleLogin() {
            disableAuthButtons();

            try {
                let result;
                try {
                    result = await signInWithPopup(auth, provider);
                } catch (popupError) {
                    if (popupError.code === 'auth/popup-blocked') {
                        console.log("Popup blocked, falling back to redirect");
                        await signInWithRedirect(auth, provider);
                        result = await getRedirectResult(auth);
                    } else {
                        throw popupError;
                    }
                }

                currentUser = result.user;
                currentSessionId = getOrCreateSessionId(currentUser.uid);

                userStatus.textContent = currentUser.displayName || currentUser.email;
                logoutBtn.style.display = 'inline-flex';
                loginModal.classList.add('hidden');
                updateHistory();
                loadSession(currentSessionId);
                statusMessage.textContent = "";

                console.log("User logged in with Google:", currentUser.uid, "session:", currentSessionId);
            } catch (error) {
                let errorMsg = "Google login failed!";
                if (error.code === 'auth/popup-blocked') {
                    errorMsg = "Popup blocked! Please allow popups or try again.";
                } else {
                    errorMsg = error.message;
                }

                statusMessage.textContent = errorMsg;
                console.error("Google login error:", error.code, error.message);
            } finally {
                enableAuthButtons();
            }
        }

        function continueAsGuest() {
            currentUser = null;
            currentSessionId = getOrCreateSessionId('guest');

            userStatus.textContent = 'Guest';
            logoutBtn.style.display = 'none';
            loginModal.classList.add('hidden');
            updateHistory();
            loadSession(currentSessionId);
            statusMessage.textContent = "";

            console.log("Continuing as guest, session:", currentSessionId);
        }

        async function handleLogout() {
            try {
                if (currentUser) localStorage.removeItem(`session_${currentUser.uid}`);
                await signOut(auth);

                currentUser = null;
                currentSessionId = getOrCreateSessionId('guest');

                userStatus.textContent = 'Guest';
                logoutBtn.style.display = 'none';
                loginModal.classList.remove('hidden');
                updateHistory();
                loadSession(currentSessionId);
                statusMessage.textContent = "";

                console.log("Logged out, back to guest mode, session:", currentSessionId);
            } catch (error) {
                statusMessage.textContent = `Logout error: ${error.message}`;
                console.error("Logout error:", error.message);
            }
        }

        function openHistory() {
            historySidebar.classList.add('open');
            console.log("History sidebar opened");
        }

        function closeHistory() {
            historySidebar.classList.remove('open');
            console.log("History sidebar closed");
        }

        function toggleSpeechRecognition() {
            if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                statusMessage.textContent = "Oops, your browser's not vibing with voice chat. Try Chrome for the full Aayushi experience!";
                console.log("Speech recognition not supported");
                micBtn.disabled = true;
                return;
            }

            if (!recognition) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'en-US';
                recognition.interimResults = true;
                recognition.continuous = false;

                recognition.onstart = () => {
                    isRecognizing = true;
                    isVoiceMode = true; // Activate voice mode
                    micBtn.classList.add('recording');
                    voiceModeIndicator.style.display = 'flex';
                    statusMessage.textContent = "I'm all ears... what's the vibe? ðŸŽ™ï¸";
                    console.log("Speech recognition started");
                };

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results).map(result => result[0].transcript).join('');
                    chatInput.value = transcript;
                    console.log("Speech recognition interim result:", transcript);

                    if (event.results[0].isFinal) {
                        recognition.stop();
                        chatForm.dispatchEvent(new Event('submit'));
                    }
                };

                recognition.onerror = (event) => {
                    isRecognizing = false;
                    isVoiceMode = false;
                    micBtn.classList.remove('recording');
                    voiceModeIndicator.style.display = 'none';
                    statusMessage.textContent = `Whoops, mic trouble: ${event.error}. Try again? ðŸ˜…`;
                    console.error("Speech recognition error:", event.error);
                };

                recognition.onend = () => {
                    isRecognizing = false;
                    micBtn.classList.remove('recording');
                    if (!chatInput.value.trim()) {
                        isVoiceMode = false;
                        voiceModeIndicator.style.display = 'none';
                    }
                    statusMessage.textContent = "";
                    console.log("Speech recognition ended");
                };
            }

            if (isRecognizing) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    statusMessage.textContent = "Mic error: " + error.message;
                    console.error("Error starting speech recognition:", error.message);
                }
            }
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle("dark-theme");
            body.classList.toggle("light-theme");

            const isDark = body.classList.contains("dark-theme");
            setThemeProperties(isDark);
            localStorage.setItem('themePreference', isDark ? 'dark' : 'light');

            console.log("Theme switched to:", isDark ? "dark" : "light");
        }

        // Event Listeners
        signInTab.addEventListener('click', showSignIn);
        createAccountTab.addEventListener('click', showCreateAccount);
        authBtn.addEventListener('click', () => isSignInMode ? handleSignIn() : handleCreateAccount());
        googleBtn.addEventListener('click', handleGoogleLogin);
        guestBtn.addEventListener('click', continueAsGuest);
        logoutBtn.addEventListener('click', handleLogout);
        historyToggle.addEventListener('click', openHistory);
        themeToggle.addEventListener('click', toggleTheme);
        closeHistoryBtn.addEventListener('click', closeHistory);
        micBtn.addEventListener('click', toggleSpeechRecognition);

        chatForm.addEventListener("submit", async (event) => {
            event.preventDefault();

            if (isProcessing) {
                console.log("Chat request blocked: another request is processing");
                return;
            }

            const message = chatInput.value.trim();
            if (!message) {
                statusMessage.textContent = "Please enter a message!";
                console.log("Empty message, ignoring");
                return;
            }

            isProcessing = true;
            chatForm.querySelectorAll('button').forEach(btn => btn.disabled = true);

            const userMessageElement = createMessageElement(message, true);
            chatContent.appendChild(userMessageElement);
            saveMessage(message, true);
            chatContent.scrollTop = chatContent.scrollHeight;

            console.log("User message displayed and saved:", message);

            const customResponse = getCustomResponse(message);
            if (customResponse) {
                await new Promise(resolve => setTimeout(resolve, 500));

                const botMessageElement = createMessageElement(customResponse, false);
                chatContent.appendChild(botMessageElement);
                saveMessage(customResponse, false);
                chatContent.scrollTop = chatContent.scrollHeight;

                if (isVoiceMode) {
                    speakText(customResponse);
                }

                console.log("Custom response displayed and saved:", customResponse);
                isProcessing = false;
                isVoiceMode = false; // Reset voice mode after response
                voiceModeIndicator.style.display = 'none';
                chatForm.querySelectorAll('button').forEach(btn => btn.disabled = false);
                return;
            }

            const apiUrl = message.toLowerCase().startsWith('/image') 
                ? 'https://backend.buildpicoapps.com/aero/run/image-generation-api?pk=v1-Z0FBQUFBQm9ZU1FFaWJCcmZ4MF81dWNEQmpBSFV2aVZ3OEFvaTRuNUhEMFZzbmlLNXA0WjdfZWd3OXI1ZzBPeW1xMU5iLVlWR3I4SXRuTU1XSHppNENXcjd5cjFWTWpoY3c9PQ=='
                : 'https://backend.buildpicoapps.com/aero/run/llm-api?pk=v1-Z0FBQUFBQm9ZU1FFaWJCcmZ4MF81dWNEQmpBSFV2aVZ3OEFvaTRuNUhEMFZzbmlLNXA0WjdfZWd3OXI1ZzBPeW1xMU5iLVlWR3I4SXRuTU1XSHppNENXcjd5cjFWTWpoY3c9PQ==';

            const prompt = message.toLowerCase().startsWith('/image') ? message.substring(6).trim() : message;

            try {
                const prependPersona = apiUrl.includes('llm-api');
                const data = await callApi(apiUrl, prompt, prependPersona);

                if (data.status === 'success') {
                    if (apiUrl.includes('image-generation-api')) {
                        const imageMessageElement = createMessageElement('', false, new Date(), true, data.imageUrl);
                        chatContent.appendChild(imageMessageElement);
                        saveMessage(`Generated image for: ${prompt}`, false, currentSessionId, true, data.imageUrl);
                        chatContent.scrollTop = chatContent.scrollHeight;
                        console.log("Image displayed and saved:", data.imageUrl);
                    } else {
                        if (data.text.trim().toLowerCase().startsWith('/image')) {
                            const imageDescription = data.text.substring(data.text.toLowerCase().indexOf('/image') + 6).trim();
                            const imageData = await callApi(
                                'https://backend.buildpicoapps.com/aero/run/image-generation-api?pk=v1-Z0FBQUFBQm9ZU1FFaWJCcmZ4MF81dWNEQmpBSFV2aVZ3OEFvaTRuNUhEMFZzbmlLNXA0WjdfZWd3OXI1ZzBPeW1xMU5iLVlWR3I4SXRuTU1XSHppNENXcjd5cjFWTWpoY3c9PQ==', 
                                imageDescription, 
                                false
                            );

                            if (imageData.status === 'success') {
                                const imageMessageElement = createMessageElement('', false, new Date(), true, imageData.imageUrl);
                                chatContent.appendChild(imageMessageElement);
                                saveMessage(`Generated image for: ${imageDescription}`, false, currentSessionId, true, imageData.imageUrl);
                                chatContent.scrollTop = chatContent.scrollHeight;
                                console.log("Image displayed and saved from text response:", imageData.imageUrl);
                            } else {
                                const errorMessageElement = createMessageElement(
                                    `Error generating image: ${imageData.error || 'Unknown error'}`, 
                                    false
                                );
                                chatContent.appendChild(errorMessageElement);
                                saveMessage(`Error generating image: ${imageData.error || 'Unknown error'}`, false);
                                console.error("Image generation error:", imageData.error);
                            }
                        } else {
                            const botMessageElement = createMessageElement(data.text, false);
                            chatContent.appendChild(botMessageElement);
                            saveMessage(data.text, false);
                            chatContent.scrollTop = chatContent.scrollHeight;
                            if (isVoiceMode) {
                                speakText(data.text);
                            }
                            console.log("Text response displayed and saved:", data.text);
                        }
                    }
                } else {
                    const errorMessageElement = createMessageElement(
                        `Error: ${data.error || 'Unknown error'}`, 
                        false
                    );
                    chatContent.appendChild(errorMessageElement);
                    saveMessage(`Error: ${data.error || 'Unknown error'}`, false);
                    console.error("API error:", data.error);
                }
            } catch (error) {
                const errorMessageElement = createMessageElement(
                    `Error: ${error.message}`, 
                    false
                );
                chatContent.appendChild(errorMessageElement);
                saveMessage(`Error: ${error.message}`, false);
                console.error("Request error:", error.message);
            }

            isProcessing = false;
            isVoiceMode = false; // Reset voice mode after response
            voiceModeIndicator.style.display = 'none';
            chatForm.querySelectorAll('button').forEach(btn => btn.disabled = false);
        });

        imageBtn.addEventListener("click", async () => {
            if (isProcessing) {
                console.log("Image request blocked: another request is processing");
                return;
            }

            if (!chatInput.value.trim().startsWith('/image')) {
                chatInput.value = `/image ${chatInput.value.trim()}`;
            }

            const prompt = chatInput.value.trim();
            if (!prompt || prompt === '/image') {
                statusMessage.textContent = "Please enter an image description!";
                console.log("Empty image prompt, ignoring");
                return;
            }

            isProcessing = true;
            chatForm.querySelectorAll('button').forEach(btn => btn.disabled = true);

            const userMessageElement = createMessageElement(prompt, true);
            chatContent.appendChild(userMessageElement);
            saveMessage(prompt, true);
            chatContent.scrollTop = chatContent.scrollHeight;

            console.log("Image generation requested:", prompt);

            try {
                const data = await callApi(
                    'https://backend.buildpicoapps.com/aero/run/image-generation-api?pk=v1-Z0FBQUFBQm9ZU1FFaWJCcmZ4MF81dWNEQmpBSFV2aVZ3OEFvaTRuNUhEMFZzbmlLNXA0WjdfZWd3OXI1ZzBPeW1xMU5iLVlWR3I4SXRuTU1XSHppNENXcjd5cjFWTWpoY3c9PQ==',
                    prompt.substring(6).trim(),
                    false
                );

                if (data.status === 'success') {
                    const imageMessageElement = createMessageElement('', false, new Date(), true, data.imageUrl);
                    chatContent.appendChild(imageMessageElement);
                    saveMessage(`Generated image for: ${prompt.substring(6).trim()}`, false, currentSessionId, true, data.imageUrl);
                    chatContent.scrollTop = chatContent.scrollHeight;
                    console.log("Image displayed and saved:", data.imageUrl);
                } else {
                    const errorMessageElement = createMessageElement(
                        `Error generating image: ${data.error || 'Unknown error'}`, 
                        false
                    );
                    chatContent.appendChild(errorMessageElement);
                    saveMessage(`Error generating image: ${data.error || 'Unknown error'}`, false);
                    console.error("Image generation error:", data.error);
                }
            } catch (error) {
                const errorMessageElement = createMessageElement(
                    `Error generating image: ${error.message}`, 
                    false
                );
                chatContent.appendChild(errorMessageElement);
                saveMessage(`Error generating image: ${error.message}`, false);
                console.error("Image generation error:", error.message);
            }

            isProcessing = false;
            isVoiceMode = false;
            voiceModeIndicator.style.display = 'none';
            chatForm.querySelectorAll('button').forEach(btn => btn.disabled = false);
        });

        // Initialize App
        document.addEventListener("DOMContentLoaded", () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    currentSessionId = getOrCreateSessionId(user.uid);

                    userStatus.textContent = user.displayName || user.email;
                    logoutBtn.style.display = 'inline-flex';
                    loginModal.classList.add('hidden');
                    updateHistory();
                    loadSession(currentSessionId);

                    console.log("User authenticated:", user.uid, "session:", currentSessionId);
                } else {
                    currentUser = null;
                    currentSessionId = getOrCreateSessionId('guest');

                    userStatus.textContent = 'Guest';
                    logoutBtn.style.display = 'none';
                    loginModal.classList.remove('hidden');
                    updateHistory();
                    loadSession(currentSessionId);

                    console.log("No user authenticated, showing login modal, session:", currentSessionId);
                }
            });

            const savedTheme = localStorage.getItem('themePreference');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
                document.body.classList.remove("dark-theme");
                document.body.classList.add("light-theme");
            }

            setThemeProperties(document.body.classList.contains("dark-theme"));
            chatInput.focus();

            if ('caches' in window) {
                caches.keys().then(names => names.forEach(name => caches.delete(name)));
            }

            // Ensure voices are loaded for text-to-speech
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log("Speech synthesis voices loaded:", speechSynthesis.getVoices());
                };
            }
        });

        // Handle Enter Key
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                isVoiceMode = false; // Disable voice mode on text input
                voiceModeIndicator.style.display = 'none';
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>